var versionNum,nodeNum,chartNodeNum,currNumberFormat,versionDazeMult,versionEnemies;let cntNoLeaks=31,versionData=null,enemyData=null,hpChart=null,versionIDs=[],hpData=[],nodeLvlData=[50,53,55,58,60,65,70],nodeHPMult=[32.13,34.6,40.8,41.58,46.04,47.74,54.06],nodeDefMult=[592,649,689,751,794,794,794],nodeDazeMult=[1.78,1.86,1.92,2,2.06,2.2,2.35],elementsData=["ice","fire","electric","ether","physical"],leaksToggle=document.getElementById("lks"),spoilersToggle=document.getElementById("spl"),menuIsOpen=!1,versionSelectorIsOpen=!1,chartIsOpen=!1;async function loadShiyuPage(){versionData=await(await fetch("shiyu-versions.json")).json(),enemyData=await(await fetch("shiyu-enemies.json")).json(),versionIDs=Object.keys(versionData),hpData=await buildHPData(versionIDs,enemyData),loadSavedState(),await showVersion(),showNode(),showChartNode(),updateNumberFormat()}async function buildHPData(e,t){let n=Array.from({length:7},()=>Array.from({length:3},()=>Array.from({length:e.length}).fill(null)));for(let o=1;o<=e.length;++o){versionEnemies=versionData[e[o-1]].versionEnemies;for(let e=1;e<=7;++e){let a=versionEnemies.nodes[e-1],s=0,l=0,r=0,i=!1;for(let d=1;d<=2;++d){let c=a.sides[d-1];for(let a=1;a<=c.waves.length;++a){let d=c.waves[a-1];for(let e=1;e<=d.enemies.length;++e){let n=d.enemies[e-1],o=t[n.id],a=n.hp,c=o.tags;for(let e=1;e<=n.count;++e)c.length>=1&&(1!=c.length||!c.includes("spoiler"))?c.includes("brute")?r+=.92*a:c.includes("robot")?r+=.9*a:c.includes("miasma")?r+=.85*a:c.includes("palicus")&&(r+=.75*a):r+=i?0:a,s+="14000"!=n.id?a:1,l+=i?0:a,i=!0}n[e-1][0][o-1]=s,n[e-1][1][o-1]=l,e>5&&(n[e-1][2][o-1]=Math.ceil(r)),i=!1}}}}return n}async function showVersion(){let e=versionIDs[versionNum-1],t=versionData[e];versionDazeMult=t.versionDazeMult,versionEnemies=t.versionEnemies,document.getElementById("v-name").innerHTML=t.versionName,document.getElementById("v-time").innerHTML=t.versionTime,document.getElementById("b-name").innerHTML=t.buffName,document.getElementById("b-desc").innerHTML=t.buffDesc,showNode()}async function prevVersion(){versionNum=1==versionNum?leaksToggle.checked?versionIDs.length:cntNoLeaks:versionNum-1,await showVersion()}async function nextVersion(){versionNum=versionNum==(leaksToggle.checked?versionIDs.length:cntNoLeaks)?1:versionNum+1,await showVersion()}function showNode(){document.getElementById("n-text").innerHTML=nodeNum,showEnemies()}function prevNode(){nodeNum=1==nodeNum?7:nodeNum-1,showNode()}function nextNode(){nodeNum=7==nodeNum?1:nodeNum+1,showNode()}function showChartNode(){displayHPChart(chartNodeNum)}function prevChartNode(){chartNodeNum=1==chartNodeNum?7:chartNodeNum-1,showChartNode()}function nextChartNode(){chartNodeNum=7==chartNodeNum?1:chartNodeNum+1,showChartNode()}function showEnemies(){let e=document.querySelector("#s1"),t=document.querySelector("#s2");e.innerHTML="",t.innerHTML="",e.style.height=nodeNum>5?"750px":"1275px",t.style.height=nodeNum>5?"750px":"1275px";let n=versionEnemies.nodes[nodeNum-1];for(let o=1;o<=2;++o){let a=1==o?e:t,s=n.sides[o-1],l=document.createElement("div");l.className="s-header",l.innerHTML=`${nodeNum}-${o} Lv${nodeLvlData[nodeNum-1]}`;let r=document.createElement("div");r.className="s-hp-daze-anom-mult",r.innerHTML=`HP: <span style="color:#ff5555;">${s.sideHPMult}%</span> | Daze: <span style="color:#ffe599;">${versionDazeMult}%</span>`,l.appendChild(r);let i=document.createElement("div"),d=s.sideElementMult;i.className="wr",generateWR(d,i),l.appendChild(i),a.appendChild(l);for(let e=1;e<=s.waves.length;++e){let t=document.createElement("div");t.className="w";let n=document.createElement("div");n.className="w-num",n.innerHTML=`WAVE ${e}`,t.appendChild(n);let o=s.waves[e-1],l=document.createElement("div");l.className="w-e";for(let e=1;e<=o.enemies.length;++e){let t=o.enemies[e-1],n=t.id,a=t.type,s=enemyData[n],r=s.tags,i=s.mods,d=spoilersToggle.checked||!r.includes("spoiler"),c=d?s.name:"SPOILER ENEMY",m=d?`shiyu-images/${s.image}.webp`:"shiyu-images/doppelganger-i.webp",u=t.hp,p=s.baseDef/50*nodeDefMult[nodeNum-1],h=s.baseDaze[a]*nodeDazeMult[nodeNum-1],g=s.stunMult,f=s.stunTime,b=s.baseAnom,y=s.elementMult;for(let e=1;e<=t.count;++e){let e=document.createElement("div");e.className="e";let n=document.createElement("img"),o=document.createElement("div"),a=document.createElement("div");n.className="e-img",o.className="e-name",a.className="e-hover",n.src=m,a.appendChild(n),o.innerHTML=c,a.appendChild(o),e.appendChild(a);let s=document.createElement("div");s.className="wr",generateWR(y,s),e.appendChild(s);let d=document.createElement("div");if(d.className="e-hp",d.innerHTML=numberFormat(u),r.length>=1&&(1!=r.length||!r.includes("spoiler"))){let e=document.createElement("div");e.className="tt-e-hp",r.includes("hitch")?(e.innerHTML=`<span style="color:#ffffff;">✦</span><span class="tt-text">${hitch(u)}</span>`,d.innerHTML=numberFormat(1)):r.includes("palicus")?e.innerHTML=`<span style="color:#93c47d;">✦</span><span class="tt-text">${palicus(u)}</span>`:r.includes("robot")?e.innerHTML=`<span style="color:#ecce45;">✦</span><span class="tt-text">${instant("#ecce45","IMPAIRED!!",c,u,5,2)}</span>`:r.includes("brute")?e.innerHTML=`<span style="color:#ecce45;">✦</span><span class="tt-text">${instant("#ecce45","IMPAIRED!!",c,u,8,1)}</span>`:r.includes("miasma")&&(e.innerHTML=`<span style="color:#d4317b;">✦</span><span class="tt-text">${instant("#d4317b","PURIFIED!!",c,u,15,1)}</span>`),d.appendChild(e)}if(e.appendChild(d),t.mult){let n=document.createElement("div");n.className="e-hp-mult",n.innerHTML=`[${t.mult}%]`,e.appendChild(n)}let N=document.createElement("div");N.className="e-def",N.innerHTML=Math.ceil(p),e.appendChild(N);let v=document.createElement("div");v.className="tt-e-stat",v.innerHTML=`+<span class="tt-text">${generateEnemyStats(versionDazeMult/100*h,g,f,b,y,i)}</span>`,e.appendChild(v),l.appendChild(e)}}t.appendChild(l),a.appendChild(t)}}document.getElementById("n-hp-raw").innerHTML=numberFormat(hpData[nodeNum-1][0][versionNum-1]),document.getElementById("n-hp-aoe").innerHTML=numberFormat(hpData[nodeNum-1][1][versionNum-1]),document.getElementById("n-hp-alt").innerHTML=hpData[nodeNum-1][2][versionNum-1]?numberFormat(hpData[nodeNum-1][2][versionNum-1]):numberFormat(hpData[nodeNum-1][1][versionNum-1]),saveProgress()}function generateWR(e,t){let n=document.createElement("img"),o=document.createElement("img"),a=document.createElement("img"),s=document.createElement("img");n.className="wk",o.className="wk",a.className="res",s.className="res",n.src="elements/none.webp",o.src="elements/none.webp",a.src="elements/none.webp",s.src="elements/none.webp";let l=0,r=0;for(let t=0;t<5;++t)e[t]<1&&0==l?(n.src=`elements/${elementsData[t]}.webp`,++l):e[t]<1&&1==l?o.src=`elements/${elementsData[t]}.webp`:e[t]>1&&0==r?(a.src=`elements/${elementsData[t]}.webp`,++r):e[t]>1&&1==r&&(s.src=`elements/${elementsData[t]}.webp`);t.appendChild(n),t.appendChild(o),t.appendChild(a),t.appendChild(s)}function hitch(e){return`<span style="font-weight:bold;text-decoration:underline;">Hitchspiker</span><br>\nTrue <span style="color:#ff5555;font-weight:bold;">Raw HP</span>: <span style="color:#ff5555;font-weight:bold;">${numberFormat(e)}</span><br><br>\ntechnically doesn't need to be killed`}function palicus(e){return`<span style="font-weight:bold;text-decoration:underline;">Palicus</span><br>\n<span style="color:#f6b26b;font-weight:bold;">Alt HP</span>: <span style="color:#93c47d;font-weight:bold;">${numberFormat(Math.ceil(75*e/100))}</span> x2<br>\n<span style="font-weight:bold;">(assume 75% of HP)</span><br><br>\nhit both 50% of the time<br>`}function instant(e,t,n,o,a,s){return`<span style="font-weight:bold;text-decoration:underline;">${n}</span><br>\n<span style="color:#f6b26b;font-weight:bold;">Alt HP</span>: <span style="color:${e};font-weight:bold;">${numberFormat(Math.ceil(o*(100-a*s)/100))}</span><br>\n<span style="font-weight:bold;">(assume ${100-a*s}% of HP)</span><br><br>\n<span style="font-weight:bold;"><span style="color:${e};">${t}</span></span> ${s} time(s)`}function generateEnemyStats(e,t,n,o,a,s){let l=[1,1,1,1,1.2],r=["#98eff0","#ff5521","#2eb6ff","#fe437e","#f0d12b"],i=`<span style="font-weight:bold;">Max Daze: <span style="color:#ffe599;">${Math.round(1e4*e)/1e4}</span></span><br>\n(<span style="color:#ffe599;font-weight:bold;">${t}%</span> DMG for <span style="color:#ffe599;font-weight:bold;">${n}s</span>)<br><br>`;if(s.includes("no-anom"))return i+'<span style="font-weight:bold;">IMMUNE TO ANOMALY</span>';i+='<span style="font-weight:bold;">Max Anomaly Buildup:</span><br>';for(let e=0;e<5;++e)i+=`<span style="color:${r[e]};font-weight:bold;">${Math.round(o*l[e]*a[e]*100)/100}</span>/`;return i=i.slice(0,-1)+"<br>"+(s.includes("no-freeze")?'<span style="color:#98eff0;font-weight:bold;">UNFREEZABLE</span>':""),i}function loadSavedState(){"true"==localStorage.getItem("leaksEnabled")&&(leaksToggle.checked=!0),"true"==localStorage.getItem("spoilersEnabled")&&(spoilersToggle.checked=!0),versionNum=leaksToggle.checked?parseInt(localStorage.getItem("lastShiyuVersion")||`${cntNoLeaks}`):cntNoLeaks,nodeNum=parseInt(localStorage.getItem("lastShiyuNode")||"7"),chartNodeNum=parseInt(localStorage.getItem("lastShiyuChartNode")||"7"),currNumberFormat=localStorage.getItem("numberFormat")||"period","true"==localStorage.getItem("leaksEnabled")&&(leaksToggle.checked=!0),"true"==localStorage.getItem("spoilersEnabled")&&(spoilersToggle.checked=!0)}function saveProgress(){localStorage.setItem("lastShiyuVersion",versionNum),localStorage.setItem("lastShiyuNode",nodeNum),localStorage.setItem("lastShiyuChartNode",chartNodeNum),localStorage.setItem("numberFormat",currNumberFormat),localStorage.setItem("leaksEnabled",leaksToggle.checked),localStorage.setItem("spoilersEnabled",spoilersToggle.checked)}function toggleMenu(){let e=document.getElementById("mb"),t=document.getElementById("mb-o"),n=document.getElementById("open-mb-btn");menuIsOpen?(document.body.classList.remove("no-scroll"),e.style.display="none",t.style.display="none",n.style.display="none"):(document.body.classList.add("no-scroll"),e.style.display="block",t.style.display="block",n.style.display="block"),menuIsOpen=!menuIsOpen}function updateNumberFormat(e){e&&(currNumberFormat=e.dataset.format);let t=document.getElementById("ex-num"),n=document.querySelectorAll(".nfb");t.innerHTML=numberFormat(2222222),n.forEach(e=>e.classList.toggle("selected",e.dataset.format==currNumberFormat)),showNode(),displayHPChart()}function numberFormat(e){return"comma"==currNumberFormat?e.toLocaleString("en-US"):"period"==currNumberFormat?e.toLocaleString("de-DE"):e}function toggleVersionSelector(){let e=document.getElementById("vs"),t=document.getElementById("vs-o");versionSelectorIsOpen?(document.body.classList.remove("no-scroll"),e.style.display="none",t.style.display="none"):(document.body.classList.add("no-scroll"),e.style.display="flex",t.style.display="block",displayVersionSelectorGrid()),versionSelectorIsOpen=!versionSelectorIsOpen}function displayVersionSelectorGrid(){let e=document.getElementById("vs").querySelector("#vg");e.innerHTML="";for(let t=1;t<=(leaksToggle.checked?versionIDs.length:cntNoLeaks);++t){let n=versionIDs[t-1],o=versionData[n],a=document.createElement("div"),s=document.createElement("div"),l=document.createElement("div");a.className="vg-c",s.className="vg-c-name",l.className="vg-c-time",s.innerHTML=o.versionName,l.innerHTML=o.versionTime,a.appendChild(s),a.appendChild(l),a.onclick=()=>{versionNum=t,toggleVersionSelector(),showVersion()},e.appendChild(a)}}function toggleChart(){let e=document.getElementById("c");chartIsOpen?(document.body.classList.remove("no-scroll"),e.style.display="none"):(document.body.classList.add("no-scroll"),e.style.display="flex"),chartIsOpen=!chartIsOpen}function downloadChart(){let e=document.createElement("a");e.href=hpChart.toBase64Image("image/png",1),e.download=`Shiyu Defense - Critical Node ${chartNodeNum} HP`,e.click()}function createHPDataset(e,t,n){return{label:e,data:t,pointRadius:2,borderWidth:2,borderColor:n,pointHoverRadius:4,pointHoverBorderWidth:2,pointHoverBorderColor:n,backgroundColor:"#ffffff"}}function displayHPChart(){const e={id:"verticalHoverLine",beforeDatasetsDraw(e,t,n){let{ctx:o,chartArea:{top:a,bottom:s,height:l}}=e;o.save();for(let t=0;t<=2;++t)e.getDatasetMeta(t).data.forEach((e,t)=>{1==e.active&&(o.beginPath(),o.strokeStyle="#888888",o.setLineDash([4,6]),o.moveTo(e.x,a),o.lineTo(e.x,s),o.stroke())});o.restore()}},t={id:"legendPadding",beforeInit(e){let t=e.legend.fit;e.legend.fit=function(){t.bind(e.legend)(),e.legend.height+=15}}},n={id:"hideTooltipOutside",afterEvent(e,t){let{top:n,bottom:o,left:a,right:s}=e.chartArea,{x:l,y:r}=t.event;(l<a||l>s||r<n||r>o)&&(e.tooltip.setActiveElements([]),e.tooltip.update(),e.setActiveElements([]),e.update())}};Chart.Tooltip.positioners.cursor=function(e,t){if(!t)return!1;let{top:n,bottom:o}=this.chart.chartArea,{x:a,y:s}=t;return s+=s<=(n+o)/3?50:-50,{x:a,y:s}},hpChart||(hpChart=new Chart("hpChart",{type:"line",plugins:[e,t,n],options:{animation:!1,responsive:!0,maintainAspectRatio:!1,interaction:{mode:"nearest",axis:"x",intersect:!1},layout:{padding:{top:10,bottom:15,left:10,right:25}},scales:{x:{offset:!0,border:{display:!1},grid:{color:"transparent"},ticks:{padding:10,font:{family:"Inconsolata",size:12},color:"#888888",maxRotation:0,callback:function(e,t){return t%2==0?this.getLabelForValue(e):""}}},y:{min:0,max:6e7,border:{display:!1},grid:{color:function(e){return e.tick.value%1e7==0?"#888888":"#444444"}},ticks:{padding:15,font:{family:"Inconsolata",size:12},color:"#888888",stepSize:5e6,callback:function(e,t){return t%2==0?numberFormat(e):""}}}},plugins:{title:{display:!0,color:"#ffffff",font:{family:"Inconsolata",size:20,weight:"bold"}},legend:{labels:{usePointStyle:!0,boxHeight:8,font:{family:"Inconsolata",size:14},generateLabels:function(e){let t=Chart.defaults.plugins.legend.labels.generateLabels(e);return t.forEach((t,n)=>{e.isDatasetVisible(n)?t.fontColor=e.data.datasets[t.datasetIndex].borderColor:(t.fontColor="#888888",t.strokeStyle="#888888")}),t}}},tooltip:{usePointStyle:!0,boxHeight:8,position:"cursor",caretSize:0,titleFont:{family:"Inconsolata",size:12,weight:"bold",lineHeight:.75},bodyFont:{family:"Inconsolata",size:12},callbacks:{labelTextColor:function(e){return e.dataset.borderColor},label:function(e){return e.dataset.label+": "+numberFormat(e.parsed.y)}}}}}})),hpChart.data.labels=versionIDs,hpChart.data.datasets=[createHPDataset("Raw HP",hpData[chartNodeNum-1][0],"#e06666"),createHPDataset("AOE HP",hpData[chartNodeNum-1][1],"#6d9eeb"),chartNodeNum>5?createHPDataset("Alt HP",hpData[chartNodeNum-1][2],"#f6b26b"):null].filter(Boolean),hpChart.options.plugins.title.text=`Shiyu Defense: Critical Node ${chartNodeNum} HP`,hpChart.update(),saveProgress()}document.addEventListener("keydown",e=>{e.stopPropagation(),"Escape"==e.key?(e.preventDefault(),chartIsOpen?toggleChart():versionSelectorIsOpen?toggleVersionSelector():toggleMenu()):" "!=e.key||menuIsOpen||chartIsOpen?"Backspace"!=e.key||menuIsOpen||versionSelectorIsOpen?"ArrowLeft"!=e.key||menuIsOpen||chartIsOpen||versionSelectorIsOpen?"ArrowRight"!=e.key||menuIsOpen||chartIsOpen||versionSelectorIsOpen?"ArrowUp"==e.key?(e.preventDefault(),menuIsOpen||chartIsOpen||versionSelectorIsOpen?nextChartNode():nextNode()):"ArrowDown"==e.key&&(e.preventDefault(),menuIsOpen||chartIsOpen||versionSelectorIsOpen?prevChartNode():prevNode()):(e.preventDefault(),nextVersion()):(e.preventDefault(),prevVersion()):(e.preventDefault(),toggleChart()):(e.preventDefault(),toggleVersionSelector())}),leaksToggle.addEventListener("change",()=>{leaksToggle.checked||(spoilersToggle.checked=!1,versionNum>cntNoLeaks&&(versionNum=cntNoLeaks)),showVersion()}),spoilersToggle.addEventListener("change",()=>{spoilersToggle.checked&&(leaksToggle.checked=!0),showEnemies()}),window.addEventListener("DOMContentLoaded",async()=>{await loadShiyuPage()});