let oldVersionNum,versionNum,nodeNum,maxNode,endingNum,currNumberFormat,versionData,enemyData,buffNames,buffDescs,versionBossDazeMult,versionEnemyDazeMult,versionBossAnomMult,versionEnemyAnomMult,versionEnemies,cntNoLeaks=2,oldModeNum=2,modeNum=2,v26=2,leaksToggle=document.getElementById("lks"),spoilersToggle=document.getElementById("spl"),menuIsOpen=versionSelectorIsOpen=!1,versionIDs=hpData=[],nodeLvlData=[],easyNodeLvlData=[55,58,60,65],pre26HardNodeLvlData=[60,63,65,70,70,70],post26HardNodeLvlData=[60,65,70,70,70],nodeEnemyHPMult=[100,116,135,157,181,193,206,220,235,271,291,314,338,364,419,431,444,458,472,543,618,703,801,912,1049,1111,1176,1246,1320,1518,1609,1706,1809,1919,2207,2320,2440,2566,2698,3103,3404,3734,4097,4494,5169,5591,6049,6544,7079,8141,8826,9569,10374,11246,12934,13260,13595,13938,14290,16434,16774,17121,17475,17837,18206,18583,18968,19361,19761,21738],nodeBossHPMult=[100,116,135,157,181,193,206,220,235,271,291,314,338,364,419,431,444,458,472,543,618,703,801,912,1049,1134,1227,1328,1437,1653,1792,1942,2106,2283,2626,2865,3126,3411,3722,4281,4717,5197,5727,6311,7258,7691,8151,8637,9153,10527,11227,11975,12772,13623,15667,15957,16252,16553,16860,19389,19716,20049,20387,20731,21081,21437,21799,22167,22541,24795],nodeDefMult=[100,108,116,124,132,142,152,164,176,188,200,214,228,242,258,274,290,306,324,344,362,382,402,422,444,466,490,512,536,562,586,612,638,666,694,722,750,780,810,842,872,904,938,970,1004,1038,1074,1110,1146,1184,1220,1258,1298,1338,1378,1418,1460,1502,1544,1588,1588,1588,1588,1588,1588,1588,1588,1588,1588,1588],nodeDazeMult=[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,101,102,103,104,104,105,106,107,108,110,113,115,118,120,123,125,128,130,133,137,142,146,151,155,160,164,169,173,178,180,183,186,189,192,195,197,200,203,206,209,212,215,217,220,223,226,229,232,235],elementsData=["ice","fire","electric","ether","physical"];async function loadThresholdPage(){versionData=await(await fetch("ts-versions.json")).json(),enemyData=await(await fetch("../assets/enemies.json")).json(),buffDescs=await(await fetch("../assets/buffs.json")).json();for(let e=1;e<=2;++e)versionIDs.push(Object.keys(versionData[e-1].versions));buildHPData(),loadSavedState(),await showVersion(),updateNumberFormat()}async function buildHPData(){hpData=[Array.from({length:4},()=>Array.from({length:7},()=>Array.from({length:1}).fill(null))),Array.from({length:6},()=>Array.from({length:7},()=>Array.from({length:versionIDs[1].length}).fill(null)))];for(let e=1;e<=2;++e)for(let n=1;n<=versionIDs[e-1].length;++n){nodeLvlData=1==e?easyNodeLvlData:n<v26?pre26HardNodeLvlData:post26HardNodeLvlData,versionEnemies=versionData[e-1].versions[versionIDs[e-1][n-1]].versionEnemies;for(let t=1;t<=versionEnemies.nodes.length;++t){let o=versionEnemies.nodes[t-1],s=alt60kEnemyHP=rawHP=aoeHP=altHP=0,a=!0,l=o.sides[0].waves[0].enemies[0],r=l.id,m=l.type,d=enemyData[r],i=Math.floor(8.74*d.baseHP[m]*nodeBossHPMult[nodeLvlData[t-1]-1]*l.mult/1e4),u=d.tags;s+=i,alt60kEnemyHP+=i,u.length>=1&&(1!=u.length||!u.includes("spoiler"))&&(u.includes("ucc")&&(alt60kEnemyHP-=.036*i),u.includes("hunter")&&(alt60kEnemyHP-=.01*i),u.includes("miasma")&&(alt60kEnemyHP-=i*("25300"==r?.045:.025)),u.includes("shutdown")&&(alt60kEnemyHP-=i*("26300"==r?.03:.015))),hpData[e-1][t-1][0][n-1]=Math.ceil(.281083138*s),hpData[e-1][t-1][1][n-1]=Math.ceil(s),hpData[e-1][t-1][2][n-1]=Math.ceil(.281083138*alt60kEnemyHP),hpData[e-1][t-1][3][n-1]=Math.ceil(alt60kEnemyHP);for(let e=2;e<=5;++e){let n=o.sides[e-1];if(null==n)continue;let s=n.sideHPMult;for(let e=1;e<=n.waves.length;++e){let o=n.waves[e-1];for(let e=1;e<=o.enemies.length;++e){let n=o.enemies[e-1],l=enemyData[n.id],r=Math.round(l.baseHP[m]*s*nodeEnemyHPMult[nodeLvlData[t-1]-1]/1e4),d=l.tags;for(let e=1;e<=n.count;++e)rawHP+="14000"!=n.id?r:1,aoeHP+=a?r:0,altHP+=r,d.length>=1&&(1!=d.length||!d.includes("spoiler")&&!d.includes("hitch"))?(d.includes("palicus")&&(altHP-=.25*r),d.includes("robot")&&(altHP-=.1*r),d.includes("brute")&&(altHP-=.08*r),d.includes("miasma")&&(altHP-=r*("26202"==n.id?.3:.15))):altHP-=a?0:r,a=!1}a=!0}}hpData[e-1][t-1][4][n-1]=rawHP,hpData[e-1][t-1][5][n-1]=aoeHP,hpData[e-1][t-1][6][n-1]=Math.ceil(altHP)}}}async function showVersion(){let e=versionData[modeNum-1].versions[versionIDs[modeNum-1][versionNum-1]];versionBossDazeMult=e.versionBossDazeMult,versionEnemyDazeMult=e.versionEnemyDazeMult,versionBossAnomMult=e.versionBossAnomMult,versionEnemyAnomMult=e.versionEnemyAnomMult,versionEnemies=e.versionEnemies,document.getElementById("v-name").innerHTML=e.versionName+(2==modeNum&&versionNum==cntNoLeaks?"<span style='color:#ff0000;font-weight:bold;'> (LIVE)</span>":""),document.getElementById("v-time").innerHTML=e.versionTime,showNode()}async function changeVersion(e){let n=parseInt(localStorage.getItem("lastTSVersion")),t=leaksToggle.checked?versionIDs[modeNum-1].length:cntNoLeaks;2==modeNum?versionNum=(versionNum-1+e+t)%t+1:(modeNum=2,versionNum=!leaksToggle.checked&&n>cntNoLeaks?cntNoLeaks:n),showVersion()}function showNode(){oldModeNum!=modeNum&&(nodeNum=2==modeNum?parseInt(localStorage.getItem("lastTSNode")):4,oldModeNum=modeNum),2==modeNum&&changePrePostNode(),maxNode=versionNum<v26?4:3,nodeLvlData=1==modeNum?easyNodeLvlData:versionNum<v26?pre26HardNodeLvlData:post26HardNodeLvlData,document.getElementById("n-text").innerHTML=`${nodeNum<maxNode?nodeNum:maxNode}`,showEndings(),showBuffs(),showEnemies()}function changeNode(e){2==modeNum&&nodeNum>maxNode&&(nodeNum=maxNode),nodeNum=(nodeNum-1+e+maxNode)%maxNode+1,2==modeNum&&nodeNum==maxNode&&(nodeNum+=endingNum-1),showNode()}function changePrePostNode(){oldVersionNum<v26&&versionNum>=v26?3==nodeNum||nodeNum>=maxNode&&nodeNum-maxNode<2?nodeNum--:nodeNum>=maxNode&&nodeNum-maxNode>=2&&(nodeNum=4):oldVersionNum>=v26&&versionNum<v26&&nodeNum>=2&&nodeNum++,oldVersionNum=versionNum}function showEndings(){if(versionNum>=v26&&endingNum>2&&(endingNum=2),2==modeNum&&nodeNum>=maxNode){document.getElementById("end").style.display="flex",document.getElementById("end-3").style.display=versionNum<v26?"flex":"none",document.querySelectorAll(".end-text").forEach(e=>e.classList.toggle("selected",e.dataset.format==endingNum))}else document.getElementById("end").style.display="none"}function changeEndings(e){endingNum=e,nodeNum=(versionNum<v26?3:2)+e,showNode()}function showBuffs(){buffNames=versionEnemies.nodes[nodeNum-1].buffNames;for(let e=1;e<=4;++e)document.getElementById(`b-img${e}`).src=`../assets/buffs/${buffNames[e-1].toLowerCase().replaceAll(" ","-")}.webp`,document.getElementById(`b-name${e}`).innerHTML=buffNames[e-1],document.getElementById(`b-desc${e}`).innerHTML=buffDescs[buffNames[e-1]]}function showEnemies(){let e=versionEnemies.nodes[nodeNum-1],n=document.querySelector("#boss"),t=document.querySelector("#s1"),o=document.querySelector("#s2"),s=document.querySelector("#s3"),a=document.querySelector("#s4");n.innerHTML="",t.innerHTML="",o.innerHTML="",s.innerHTML="",a.innerHTML="";for(let l=1;l<=5;++l){let r=1==l?n:2==l?t:3==l?o:4==l?s:a,m=e.sides[l-1],d=document.createElement("div");d.className="s-header",d.innerHTML=`${1==l?"Final BATTLE":l<=4?"Required":"Optional"} ${nodeNum<maxNode?nodeNum:maxNode}${2!=modeNum||nodeNum<maxNode?"":"."+(nodeNum-maxNode+1)}${1!=l?"-"+(l-1):""} Lv${nodeLvlData[nodeNum-1]}`;let i=document.createElement("div");if(i.className="s-hp-daze-anom-mult",i.innerHTML='HP: <span style="color:#ff5555;">N/A</span> | Daze: <span style="color:#ffe599;">N/A</span> | Anom: <span style="color:#7756c6;">N/A</span>',d.appendChild(i),l>=2){let n=document.createElement("div");n.className="wr",generateWR(null!=m?e.sides[l-1].sideElementMult:[1,1,1,1,1],n),d.appendChild(n)}if(r.appendChild(d),null==m)continue;let u=1==l?m.waves[0].enemies[0].mult:m.sideHPMult;i.innerHTML=`HP: <span style="color:#ff5555;">${1==modeNum?Math.round(100*u)/100:u}%</span> | Daze: <span style="color:#ffe599;">${1==l?versionBossDazeMult:versionEnemyDazeMult}%</span> | Anom: <span style="color:#7756c6;">${1==l?versionBossAnomMult:versionEnemyAnomMult}%</span>`;for(let e=1;e<=m.waves.length;++e){let t=document.createElement("div");if(t.className="w",l>=2){let n=document.createElement("div");n.className="w-num",n.innerHTML=`WAVE ${e}`,t.appendChild(n)}let o=m.waves[e-1],s=document.createElement("div");s.className="w-e";for(let e=1;e<=o.enemies.length;++e){let t=o.enemies[e-1],a=t.id,m=t.type,d=enemyData[a],i=d.tags,c=d.mods,p=spoilersToggle.checked||!i.includes("spoiler"),N=p?d.name:l>=2?"SPOILER ENEMY":"SPOILER BOSS",g=p?`../assets/enemies/${d.image}.webp`:"../assets/enemies/doppelganger-i.webp",h=(1==l?Math.floor:Math.round)(u*d.baseHP[m]*(1==l?8.74:1)*(1==l?nodeBossHPMult:nodeEnemyHPMult)[nodeLvlData[nodeNum-1]-1]/1e4),f=d.baseDef*nodeDefMult[nodeLvlData[nodeNum-1]-1]/100,v=d.baseDaze[m]*nodeDazeMult[nodeLvlData[nodeNum-1]-1]*("24300"==a?.8:1)/100,y=d.stunMult,b=d.stunTime,E=d.baseAnom,M=d.elementMult;for(let e=1;e<=t.count;++e){let e=document.createElement("div");e.className="e";let t=document.createElement("img"),o=document.createElement("div"),u=document.createElement("div");t.className="e-img",o.className="e-name",u.className="e-hover",t.src=g,u.appendChild(t),o.innerHTML=N,u.appendChild(o),e.appendChild(u);let p=document.createElement("div");p.className="wr",generateWR(M,p,l),e.appendChild(p);let D=document.createElement("div");if(D.className="e-hp",D.innerHTML=numberFormat(h),i.length>=1&&(1!=i.length||!i.includes("spoiler"))){let e=document.createElement("div");if(e.className="tt-e-hp",l>=2&&(e.style.fontSize="36px",e.style.top="-19px",e.style.right="87px"),i.includes("hitch"))e.innerHTML=hitch(h)+"<br>",D.innerHTML=numberFormat(1);else{let n=h,t="#ffffff";i.includes("palicus")&&(n-=.25*h,t="#93c47d",e.innerHTML+=palicus(n)+"<br>"),i.includes("robot")&&(n-=.1*h,t="#ca9a00",e.innerHTML+=instant(t,"IMPAIRED!!",2)+"<br>"),i.includes("brute")&&(n-=.08*h,t="#ca9a00",e.innerHTML+=instant(t,"IMPAIRED!!",1)+"<br>"),i.includes("ucc")&&(n-=.036*h,t="#ca9a00",e.innerHTML+=instant(t,"IMPAIRED!!",3)+" on<br>legs, 3 time(s) on core<br>"),i.includes("hunter")&&(n-=.01*h,t="#ca9a00",e.innerHTML+=instant(t,"IMPAIRED!!",1)+"<br>"),i.includes("miasma")&&(n-=h*("3"!=a[2]?.15:"25300"==a?.045:.025),t="#b4317b",e.innerHTML+=instant(t,"PURIFIED!!","25300"==a?3:1)+"<br>"),i.includes("shutdown")&&(n-=h*("26300"==a?.03:.015),t="#b47ede",e.innerHTML+=instant(t,"SHUTDOWN!!","26300"==a?2:1)+"<br>"),e.innerHTML=alt(t,N,n,h)+e.innerHTML}D.appendChild(e)}e.appendChild(D);let L=document.createElement("div");L.className="e-def",L.innerHTML=Math.ceil(f),e.appendChild(L);let H=document.createElement("div");if(H.className="tt-e-stat",H.innerHTML=`+</span><span class="tt-text">${generateEnemyStats(("3"==a[2]?versionBossDazeMult:versionEnemyDazeMult)/100*v,y,b,("3"==a[2]?versionBossAnomMult:versionEnemyAnomMult)/100*E,M,c)}</span>`,e.appendChild(H),l>=2&&(t.style.height=u.style.maxHeight=u.style.width="108px",o.style.fontSize=D.style.fontSize=L.style.fontSize="12px",s.style.padding="15px"),s.appendChild(e),r==n&&"3"==a[2]){document.querySelector(".esd")?.remove();let e=document.createElement("div");e.className="esd",e.innerHTML=i.includes("spoiler")&&!spoilersToggle.checked?`${d.spoilerDesc}<br><br>${d.spoilerPerf}`:`${d.desc[m]}<br><br>${d.perf[m]}`,e.innerHTML+="<br><br>• When an extra score multiplier is active in this stage, the <span style='color:#ffaf2c;font-weight:bold;'>Performance Points</span> cap will increase accordingly.",e.innerHTML+=""+("2"==a[0]||"14303"==a||"14302"==a?`<br><br>${d.misc}`:""),n.parentElement.appendChild(e)}}}t.appendChild(s),r.appendChild(t)}}document.getElementById("n-hp-b-raw-20000").innerHTML=numberFormat(hpData[modeNum-1][nodeNum-1][0][versionNum-1]),document.getElementById("n-hp-b-raw-60000").innerHTML=numberFormat(hpData[modeNum-1][nodeNum-1][1][versionNum-1]),document.getElementById("n-hp-b-alt-20000").innerHTML=numberFormat(hpData[modeNum-1][nodeNum-1][2][versionNum-1]),document.getElementById("n-hp-b-alt-60000").innerHTML=numberFormat(hpData[modeNum-1][nodeNum-1][3][versionNum-1]),document.getElementById("n-hp-raw").innerHTML=numberFormat(hpData[modeNum-1][nodeNum-1][4][versionNum-1]),document.getElementById("n-hp-aoe").innerHTML=numberFormat(hpData[modeNum-1][nodeNum-1][5][versionNum-1]),document.getElementById("n-hp-alt").innerHTML=numberFormat(hpData[modeNum-1][nodeNum-1][6][versionNum-1]),2==modeNum&&saveLastPage(),saveSettings()}function generateWR(e,n,t){let o=document.createElement("img"),s=document.createElement("img"),a=document.createElement("img"),l=document.createElement("img");o.className="wk",s.className="wk",a.className="res",l.className="res",1==t&&(o.style.width="24px",s.style.width="24px",a.style.width="24px",l.style.width="24px"),o.src="../assets/elements/none.webp",s.src="../assets/elements/none.webp",a.src="../assets/elements/none.webp",l.src="../assets/elements/none.webp";let r=resCnt=0;for(let n=0;n<5;++n)e[n]<1&&0==r?(o.src=`../assets/elements/${elementsData[n]}.webp`,++r):e[n]<1&&1==r?s.src=`../assets/elements/${elementsData[n]}.webp`:e[n]>1&&0==resCnt?(a.src=`../assets/elements/${elementsData[n]}.webp`,++resCnt):e[n]>1&&1==resCnt&&(l.src=`../assets/elements/${elementsData[n]}.webp`);n.appendChild(o),n.appendChild(s),n.appendChild(a),n.appendChild(l)}function alt(e,n,t,o){return`<span style="color:${e};">✦</span><span class="tt-text">\n<span style="font-weight:bold;text-decoration:underline;">${n}</span><br>\n<span style="color:#f6b26b;font-weight:bold;">Alt HP</span>: <span style="color:${e};font-weight:bold;">${numberFormat(Math.ceil(t))}</span><br>\n<span style="font-weight:bold;">(assume ${Math.round(t/o*1e3)/10}% of HP)</span><br><br>`}function hitch(e){return`<span style="color:#ffffff;">✦</span><span class="tt-text">\n<span style="font-weight:bold;text-decoration:underline;">Hitchspiker</span><br>\nTrue <span style="color:#ff5555;font-weight:bold;">Raw HP</span>: <span style="color:#ff5555;font-weight:bold;">${numberFormat(e)}</span><br><br>\ntechnically doesn't<br>need to be killed</span>`}function palicus(){return"hit both 50% of the time</span>"}function instant(e,n,t){return`<span style="font-weight:bold;"><span style="color:${e};">${n}</span></span> ${t} time(s)</span>`}function generateEnemyStats(e,n,t,o,s,a){let l=[1,1,1,1,1.2],r=["#98eff0","#ff5521","#2eb6ff","#fe437e","#f0d12b"],m=`<span style="font-weight:bold;">Max Daze: <span style="color:#ffe599;">${Math.round(1e4*e)/1e4}</span></span><br>\n(<span style="color:#ffe599;font-weight:bold;">${n}%</span> DMG for <span style="color:#ffe599;font-weight:bold;">${t}s</span>)<br><br>`;if(a.includes("no-anom"))return m+'<span style="font-weight:bold;">IMMUNE TO ANOMALY</span>';m+='<span style="font-weight:bold;">Max Anomaly Buildup:</span><br>';for(let e=0;e<5;++e)m+=`<span style="color:${r[e]};font-weight:bold;">${Math.round(o*l[e]*s[e]*100)/100}</span>/`;return m=m.slice(0,-1)+"<br>"+(a.includes("no-freeze")?'<span style="color:#98eff0;font-weight:bold;">UNFREEZABLE</span>':""),m}function loadSavedState(){"true"==localStorage.getItem("leaksEnabled")&&(leaksToggle.checked=!0),"true"==localStorage.getItem("spoilersEnabled")&&(spoilersToggle.checked=!0),versionNum=parseInt(localStorage.getItem("lastTSVersion")||`${cntNoLeaks}`),oldVersionNum=versionNum,nodeNum=parseInt(localStorage.getItem("lastTSNode")||"3"),endingNum=parseInt(localStorage.getItem("lastTSEnding")||"1"),currNumberFormat=localStorage.getItem("numberFormat")||"period",leaksToggle.checked||(versionNum=Math.min(versionNum,cntNoLeaks)),saveLastPage(),saveSettings()}function saveLastPage(){localStorage.setItem("lastTSVersion",versionNum),localStorage.setItem("lastTSNode",nodeNum),localStorage.setItem("lastTSEnding",endingNum)}function saveSettings(){localStorage.setItem("numberFormat",currNumberFormat),localStorage.setItem("leaksEnabled",leaksToggle.checked),localStorage.setItem("spoilersEnabled",spoilersToggle.checked)}function toggleMenu(){let e=document.getElementById("mb"),n=document.getElementById("mb-o"),t=document.getElementById("open-mb-btn");menuIsOpen?(document.body.classList.remove("no-scroll"),e.style.display="none",n.style.display="none",t.style.display="none"):(document.body.classList.add("no-scroll"),e.style.display="block",n.style.display="block",t.style.display="block"),menuIsOpen=!menuIsOpen}function updateNumberFormat(e){e&&(currNumberFormat=e.dataset.format);let n=document.getElementById("ex-num"),t=document.querySelectorAll(".nfb");n.innerHTML=numberFormat(2222222),t.forEach(e=>e.classList.toggle("selected",e.dataset.format==currNumberFormat)),showEnemies()}function numberFormat(e){return"comma"==currNumberFormat?e.toLocaleString("en-US"):"period"==currNumberFormat?e.toLocaleString("de-DE"):e}function toggleVersionSelector(){let e=document.getElementById("vs"),n=document.getElementById("vs-o");versionSelectorIsOpen?(document.body.classList.remove("no-scroll"),e.style.display="none",n.style.display="none"):(document.body.classList.add("no-scroll"),e.style.display="flex",n.style.display="block",displayVersionSelectorGrid()),versionSelectorIsOpen=!versionSelectorIsOpen}function displayVersionSelectorGrid(){let e=document.getElementById("vs"),n=e.querySelector("#vg"),t=e.querySelector("#vg-row1"),o=e.querySelector("#vg-title"),s=e.querySelector("#vg-row2");t.innerHTML="",o.innerHTML="Hard Mode",s.innerHTML="";for(let e=1;e<=2;++e)for(let n=1;n<=(2==e?leaksToggle.checked?versionIDs[e-1].length:cntNoLeaks:1);++n){let o=versionData[e-1].versions[versionIDs[e-1][n-1]],a=document.createElement("div"),l=document.createElement("div"),r=document.createElement("div");a.className="vg-c",l.className="vg-c-name",r.className="vg-c-time",l.innerHTML=o.versionName+(2==e&&n==cntNoLeaks?"<span style='color:#ff0000;font-weight:bold;'> (LIVE)</span>":""),r.innerHTML=o.versionTime,a.appendChild(l),a.appendChild(r),a.onclick=()=>{modeNum=e,versionNum=2==modeNum?n:1,toggleVersionSelector(),showVersion()},2!=e?t.appendChild(a):s.appendChild(a)}n.appendChild(t),n.appendChild(o),n.appendChild(s)}document.addEventListener("keydown",e=>{e.stopPropagation(),e.shiftKey||e.ctrlKey||e.metaKey||e.altKey||("Escape"==e.key?(e.preventDefault(),versionSelectorIsOpen?toggleVersionSelector():toggleMenu()):" "!=e.key||menuIsOpen?"ArrowLeft"!=e.key||menuIsOpen||versionSelectorIsOpen?"ArrowRight"!=e.key||menuIsOpen||versionSelectorIsOpen?"ArrowUp"!=e.key||menuIsOpen||versionSelectorIsOpen?"ArrowDown"!=e.key||menuIsOpen||versionSelectorIsOpen||(e.preventDefault(),changeNode(-1)):(e.preventDefault(),changeNode(1)):(e.preventDefault(),changeVersion(1)):(e.preventDefault(),changeVersion(-1)):(e.preventDefault(),toggleVersionSelector()))}),leaksToggle.addEventListener("change",()=>{leaksToggle.checked||(spoilersToggle.checked=!1,versionNum>cntNoLeaks&&(versionNum=cntNoLeaks)),showVersion()}),spoilersToggle.addEventListener("change",()=>{spoilersToggle.checked&&(leaksToggle.checked=!0),showEnemies()}),window.addEventListener("DOMContentLoaded",async()=>{await loadThresholdPage()});